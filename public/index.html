<!-- 
  ==============================================================
  KOD "RUANG MAKAN" YANG BETUL & TERAKHIR
  Gantikan semua kod lama dalam public/index.html dengan kod ini.
  ==============================================================
-->
<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DramaStream (Vercel)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #0f0f0f; color: #e0e0e0; margin: 0; }
        .container { padding: 0 20px; }
        h1, h2, h3 { color: #ffffff; }
        h1 { color: #E50914; font-size: 2.5em; }
        header { padding: 20px 0; }
        .search-container { margin: 20px 0; display: flex; gap: 10px; }
        #searchInput { flex-grow: 1; padding: 12px; border-radius: 4px; border: 1px solid #333; background-color: #1e1e1e; color: #e0e0e0; font-size: 16px; }
        #searchButton { padding: 12px 24px; border-radius: 4px; border: none; background-color: #E50914; color: white; font-size: 16px; cursor: pointer; transition: background-color 0.2s; }
        #searchButton:hover { background-color: #f40612; }
        .category-section { margin-bottom: 40px; }
        .drama-grid { display: flex; overflow-x: auto; overflow-y: hidden; gap: 15px; padding-bottom: 20px; scrollbar-width: thin; scrollbar-color: #333 #1e1e1e; }
        .drama-grid::-webkit-scrollbar { height: 8px; }
        .drama-grid::-webkit-scrollbar-track { background: #1e1e1e; }
        .drama-grid::-webkit-scrollbar-thumb { background-color: #333; border-radius: 10px; }
        .drama-card { flex: 0 0 180px; background-color: #1e1e1e; border-radius: 8px; overflow: hidden; cursor: pointer; transition: transform 0.2s ease-in-out; position: relative; }
        .drama-card:hover { transform: scale(1.08); z-index: 10; }
        .drama-card img { width: 100%; height: 250px; object-fit: cover; }
        .drama-card-title { padding: 10px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.9em; }
        #videoPlayerContainer { margin-top: 30px; }
        #videoPlayer { width: 100%; max-width: 900px; background-color: #000; border-radius: 8px; }
        .episode-header { display: flex; justify-content: space-between; align-items: center; max-width: 900px; }
        #episodeList { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; max-width: 900px; }
        .episode-item { background-color: #282828; padding: 15px; text-align: center; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; }
        .episode-item:hover { background-color: #383838; }
        .episode-item.playing { background-color: #E50914; color: white; }
        .autoplay-container { display: flex; align-items: center; gap: 10px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: #E50914; }
        input:focus + .slider { box-shadow: 0 0 1px #E50914; }
        input:checked + .slider:before { transform: translateX(22px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }
        .loading { text-align: center; padding: 50px; font-size: 1.2em; width: 100%; }
        @media (max-width: 768px) { .container { padding: 0 10px; } h1 { font-size: 2em; } .drama-card { flex-basis: 140px; } .drama-card img { height: 200px; } #episodeList { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>DramaStream</h1>
            <div class="search-container"><input type="text" id="searchInput" placeholder="Cari drama..."><button id="searchButton">Cari</button></div>
        </header>
        <div id="videoPlayerContainer" style="display:none;">
            <h2 id="videoTitle"></h2><video id="videoPlayer" controls controlsList="nodownload"></video>
            <div class="episode-header">
                <h3>Episod</h3>
                <div class="autoplay-container">
                    <label class="switch"><input type="checkbox" id="autoplayToggle" checked><span class="slider round"></span></label><span>Autoplay</span>
                </div>
            </div>
            <div id="episodeList"></div>
        </div>
        <main id="category-container"></main>
    </div>

    <script>
        const config = { apiBaseUrl: "/api" }; // Laluan ke "dapur" kita

        // Rujukan elemen-elemen HTML
        const categoryContainer = document.getElementById('category-container');
        // (Rujukan elemen lain...)

        async function apiCall(endpoint, lang = 'in') {
            // PEMBETULAN: Cara baru panggil 'dapur' Vercel
            const url = `${config.apiBaseUrl}${endpoint}?lang=${lang}`;
            console.log(`Membuat panggilan ke Vercel Function: ${url}`);
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    // Cuba dapatkan teks ralat dari respons jika ada
                    const errorText = await response.text();
                    throw new Error(`Ralat HTTP: ${response.status} - ${errorText}`);
                }
                const data = await response.json();
                return data.data; 
            } catch (error) {
                console.error("### RALAT SEMASA MEMANGGIL API ###:", error);
                categoryContainer.innerHTML = `<div class="loading">Gagal memuatkan data. Sila periksa log Vercel.</div>`;
                return null;
            }
        }
        
        // (SEMUA FUNGSI LAIN DI BAWAH INI TIDAK BERUBAH)
        function displayCategory(title, dramas, gridId) {
            const section = document.createElement('section'); section.className = 'category-section';
            const h2 = document.createElement('h2'); h2.textContent = title; section.appendChild(h2);
            const grid = document.createElement('div'); grid.className = 'drama-grid'; grid.id = gridId; section.appendChild(grid);
            categoryContainer.appendChild(section);
            if (!dramas || dramas.length === 0) { grid.innerHTML = '<div class="loading">Tiada drama dalam kategori ini.</div>'; return; }
            dramas.forEach(drama => {
                const card = document.createElement('div'); card.className = 'drama-card';
                card.innerHTML = `<img src="${drama.cover}" alt="${drama.bookName}"><div class="drama-card-title">${drama.bookName}</div>`;
                card.addEventListener('click', () => fetchEpisodes(drama.bookId, drama.bookName));
                grid.appendChild(card);
            });
        }
        async function loadAllCategories() {
            categoryContainer.innerHTML = '<div class="loading">Memuatkan semua kategori...</div>';
            const categories = [ { title: "Terbaru", endpoint: "/dramabox/api/v1/new/1" }, { title: "Paling Hangat", endpoint: "/dramabox/api/v1/hot/1?pageSize=50" }, { title: "Mesti Tonton", endpoint: "/dramabox/api/v1/must-watch/1?pageSize=50" }];
            const responses = await Promise.all(categories.map(cat => apiCall(cat.endpoint)));
            categoryContainer.innerHTML = '';
            responses.forEach((data, index) => { if (data && data.list) { displayCategory(categories[index].title, data.list, `grid-${index}`); } });
        }
        async function fetchEpisodes(bookId, title) {
            document.getElementById('category-container').style.display = 'none';
            const videoContainer = document.getElementById('videoPlayerContainer'); videoContainer.style.display = 'block';
            document.getElementById('videoTitle').textContent = title;
            const epList = document.getElementById('episodeList'); epList.innerHTML = '<div class="loading">Memuatkan episod...</div>';
            window.scrollTo(0, 0);
            const responseData = await apiCall(`/dramabox/api/v1/chapters/${bookId}`);
            if (responseData && responseData.chapterList) { displayEpisodes(responseData.chapterList, bookId); } else { displayEpisodes([], bookId); }
        }
        function displayEpisodes(episodes, bookId) {
            const epList = document.getElementById('episodeList'); epList.innerHTML = '';
            if (!episodes || episodes.length === 0) { epList.innerHTML = '<div class="loading">Tiada episod ditemui.</div>'; return; }
            episodes.forEach(episode => {
                const item = document.createElement('div'); item.className = 'episode-item';
                item.textContent = `Episod ${episode.chapterIndex + 1}`;
                item.dataset.index = episode.chapterIndex;
                item.addEventListener('click', () => playVideo(bookId, episode.chapterIndex));
                epList.appendChild(item);
            });
        }
        async function playVideo(bookId, index) {
            const videoPlayer = document.getElementById('videoPlayer');
            const videoData = await apiCall(`/dramabox/api/v1/watch/${bookId}/${index}`);
            if (videoData && videoData.videoUrl) {
                videoPlayer.src = videoData.videoUrl; videoPlayer.play();
                document.getElementById('videoTitle').textContent = `${document.getElementById('videoTitle').textContent.split(' (Episod')[0]} (Episod ${index + 1})`;
                videoPlayer.dataset.currentEpisodeIndex = index;
                document.querySelectorAll('.episode-item').forEach(item => item.classList.remove('playing'));
                const currentEp = document.querySelector(`.episode-item[data-index='${index}']`);
                if (currentEp) currentEp.classList.add('playing');
            } else { alert("Gagal mendapatkan URL video."); }
        }
        document.getElementById('videoPlayer').addEventListener('ended', () => {
            if (document.getElementById('autoplayToggle').checked) {
                const currentIndex = parseInt(document.getElementById('videoPlayer').dataset.currentEpisodeIndex, 10);
                const nextButton = document.querySelector(`.episode-item[data-index='${currentIndex + 1}']`);
                if (nextButton) nextButton.click();
            }
        });
        async function searchDramas() { /* ... fungsi carian ... */ }
        document.getElementById('searchButton').addEventListener('click', searchDramas);
        document.getElementById('searchInput').addEventListener('keypress', e => { if (e.key === 'Enter') searchDramas(); });
        loadAllCategories();
    </script>
</body>
</html>
