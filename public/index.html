<!-- KOD UNTUK diletak dalam public/index.html -->
<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DramaBox Streaming (Vercel)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1, h2 { color: #ffffff; border-bottom: 2px solid #333; padding-bottom: 10px; }
        .search-container { margin: 20px 0; display: flex; gap: 10px; }
        #searchInput { flex-grow: 1; padding: 10px; border-radius: 5px; border: 1px solid #333; background-color: #1e1e1e; color: #e0e0e0; font-size: 16px; }
        #searchButton { padding: 10px 20px; border-radius: 5px; border: none; background-color: #007bff; color: white; font-size: 16px; cursor: pointer; }
        #searchButton:hover { background-color: #0056b3; }
        #dramaGrid, #episodeList { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .drama-card { background-color: #1e1e1e; border-radius: 8px; overflow: hidden; cursor: pointer; transition: transform 0.2s; }
        .drama-card:hover { transform: scale(1.05); }
        .drama-card img { width: 100%; height: 280px; object-fit: cover; }
        .drama-card-title { padding: 10px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #videoPlayerContainer { margin-top: 30px; }
        #videoPlayer { width: 100%; background-color: #000; }
        #episodeList { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
        .episode-item { background-color: #282828; padding: 15px; text-align: center; border-radius: 5px; cursor: pointer; }
        .episode-item:hover { background-color: #383838; }
        .loading { text-align: center; padding: 50px; font-size: 1.2em; }
    </style>
</head>
<body>
    <div class="container">
        <h1>DramaBox Streaming</h1>
        <div class="search-container"><input type="text" id="searchInput" placeholder="Cari drama..."><button id="searchButton">Cari</button></div>
        <div id="videoPlayerContainer" style="display:none;"><h2 id="videoTitle"></h2><video id="videoPlayer" controls></video><h3>Episod</h3><div id="episodeList"></div></div>
        <h2>Senarai Drama</h2>
        <div id="dramaGrid"><div class="loading">Memuatkan drama...</div></div>
    </div>

    <script>
        const config = { apiBaseUrl: "/api/proxy" };
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const dramaGrid = document.getElementById('dramaGrid');
        const videoPlayerContainer = document.getElementById('videoPlayerContainer');
        const videoPlayer = document.getElementById('videoPlayer');
        const videoTitle = document.getElementById('videoTitle');
        const episodeList = document.getElementById('episodeList');
        async function apiCall(endpoint, lang = 'in') {
            const url = `${config.apiBaseUrl}${endpoint}?lang=${lang}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Ralat HTTP! Status: ${response.status}`);
                const data = await response.json();
                return data.data; 
            } catch (error) {
                console.error("### RALAT ###:", error);
                dramaGrid.innerHTML = `<div class="loading">Gagal dimuatkan. Sila periksa log Vercel.</div>`;
                return null;
            }
        }
        function displayDramas(dramas) {
            dramaGrid.innerHTML = '';
            if (!dramas || !Array.isArray(dramas) || dramas.length === 0) {
                if (dramaGrid.innerHTML.includes('loading')) return;
                dramaGrid.innerHTML = '<div class="loading">Tiada drama ditemui.</div>';
                return;
            }
            dramas.forEach(drama => {
                const card = document.createElement('div');
                card.className = 'drama-card';
                card.dataset.bookid = drama.bookId; 
                card.dataset.title = drama.bookName;
                const img = document.createElement('img');
                img.src = drama.cover;
                img.alt = drama.bookName;
                const title = document.createElement('div');
                title.className = 'drama-card-title';
                title.textContent = drama.bookName;
                card.appendChild(img);
                card.appendChild(title);
                card.addEventListener('click', () => fetchEpisodes(drama.bookId, drama.bookName));
                dramaGrid.appendChild(card);
            });
        }
        async function fetchEpisodes(bookId, title) {
            videoPlayerContainer.style.display = 'block';
            videoTitle.textContent = title;
            episodeList.innerHTML = '<div class="loading">Memuatkan episod...</div>';
            window.scrollTo(0, 0);
            const responseData = await apiCall(`/dramabox/api/v1/chapters/${bookId}`);
            if (responseData && responseData.chapterList) {
                displayEpisodes(responseData.chapterList, bookId);
            } else {
                displayEpisodes([], bookId);
            }
        }
        function displayEpisodes(episodes, bookId) {
            episodeList.innerHTML = '';
            if (!episodes || !Array.isArray(episodes) || episodes.length === 0) {
                episodeList.innerHTML = '<div class="loading">Tiada episod ditemui.</div>';
                return;
            }
            episodes.forEach(episode => {
                const item = document.createElement('div');
                item.className = 'episode-item';
                item.textContent = `Episod ${episode.chapterIndex + 1}`;
                item.dataset.bookid = bookId;
                item.dataset.index = episode.chapterIndex;
                item.addEventListener('click', () => playVideo(bookId, episode.chapterIndex));
                episodeList.appendChild(item);
            });
        }
        async function playVideo(bookId, index) {
            const videoData = await apiCall(`/dramabox/api/v1/watch/${bookId}/${index}`);
            if (videoData && videoData.videoUrl) {
                videoPlayer.src = videoData.videoUrl;
                videoPlayer.play();
                videoTitle.textContent = `${videoTitle.textContent.split(' (Episod')[0]} (Episod ${index + 1})`;
            } else {
                alert("Gagal mendapatkan URL video.");
            }
        }
        async function searchDramas() {
            const keyword = searchInput.value;
            if (keyword) {
                dramaGrid.innerHTML = '<div class="loading">Mencari...</div>';
                const responseData = await apiCall(`/dramabox/api/v1/search/${keyword}/1?pageSize=50`);
                if (responseData && responseData.list) {
                    displayDramas(responseData.list);
                } else {
                    displayDramas([]);
                }
            }
        }
        async function fetchNewReleases() {
            const responseData = await apiCall('/dramabox/api/v1/new/1');
            if (responseData && responseData.list) {
                displayDramas(responseData.list);
            }
        }
        searchButton.addEventListener('click', searchDramas);
        searchInput.addEventListener('keypress', e => { if (e.key === 'Enter') searchDramas(); });
        fetchNewReleases();
    </script>
</body>
</html>
