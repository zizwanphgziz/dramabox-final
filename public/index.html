<!-- 
  ==============================================================
  KOD "RUANG MAKAN" TERAKHIR (SESUAI DENGAN api/proxy.js)
  Gantikan semua kod lama dalam public/index.html dengan kod ini.
  ==============================================================
-->
<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DramaStream Pro (Vercel - Stabil)</title>
    <!-- Semua CSS adalah sama seperti versi Netflix -->
    <style>
        :root { --brand-color: #E50914; --background-color: #0f0f0f; --surface-color: #1e1e1e; --text-primary: #ffffff; --text-secondary: #aaaaaa; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--background-color); color: var(--text-primary); margin: 0; }
        .container { padding: 0 4%; }
        h1, h2, h3 { color: var(--text-primary); }
        h1 { color: var(--brand-color); font-size: 2.5em; font-weight: 700; }
        h2 { font-size: 1.8em; }
        header { padding: 20px 0; }
        .search-container { margin: 20px 0; display: flex; gap: 10px; }
        #searchInput { flex-grow: 1; padding: 12px; border-radius: 4px; border: 1px solid #333; background-color: var(--surface-color); color: var(--text-primary); font-size: 16px; }
        #searchButton { padding: 12px 24px; border-radius: 4px; border: none; background-color: var(--brand-color); color: white; font-size: 16px; cursor: pointer; transition: background-color 0.2s; }
        #searchButton:hover { background-color: #f40612; }
        .category-section { margin-bottom: 40px; }
        .drama-grid { display: flex; overflow-x: auto; overflow-y: hidden; gap: 15px; padding-bottom: 20px; scrollbar-width: thin; scrollbar-color: #333 #1e1e1e; }
        .drama-grid::-webkit-scrollbar { height: 8px; }
        .drama-grid::-webkit-scrollbar-track { background: transparent; }
        .drama-grid::-webkit-scrollbar-thumb { background-color: #333; border-radius: 10px; }
        .drama-card { flex: 0 0 180px; background-color: var(--surface-color); border-radius: 8px; overflow: hidden; cursor: pointer; transition: transform 0.2s ease-in-out, box-shadow 0.2s; position: relative; }
        .drama-card:hover { transform: scale(1.08); z-index: 10; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .drama-card img { width: 100%; height: 250px; object-fit: cover; }
        .drama-card-title { padding: 10px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.9em; }
        .back-button { background: none; border: none; color: var(--text-secondary); font-size: 1.2em; cursor: pointer; margin: 20px 0; display: block; }
        .back-button:hover { color: var(--text-primary); }
        #videoPlayer { width: 100%; max-width: 900px; background-color: #000; border-radius: 8px; margin: 0 auto; display: block; }
        .episode-section { max-width: 900px; margin: 20px auto; }
        .episode-header { display: flex; justify-content: space-between; align-items: center; }
        #episodeList { max-height: 400px; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; padding-right: 10px; }
        .episode-item { background-color: #282828; padding: 15px; text-align: center; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; }
        .episode-item:hover { background-color: #383838; }
        .episode-item.playing { background-color: var(--brand-color); color: white; }
        .autoplay-container { display: flex; align-items: center; gap: 10px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: var(--brand-color); }
        input:checked + .slider:before { transform: translateX(22px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }
        .loading { text-align: center; padding: 50px; font-size: 1.2em; width: 100%; }
        @media (max-width: 768px) { .container { padding: 0 10px; } h1 { font-size: 2em; } .drama-card { flex-basis: 140px; } .drama-card img { height: 200px; } #episodeList { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); } }
    </style>
</head>
<body>
    <div class="container">
        <div id="homepage">
            <header><h1>DramaStream</h1><div class="search-container"><input type="text" id="searchInput" placeholder="Cari..."><button id="searchButton">Cari</button></div></header>
            <main id="category-container"></main>
        </div>
        <div id="details-page" style="display:none;">
            <button class="back-button" id="backButton">&larr; Kembali</button>
            <div id="videoPlayerContainer">
                <h2 id="videoTitle"></h2>
                <video id="videoPlayer" controls controlsList="nodownload"></video>
            </div>
            <div class="episode-section">
                <div class="episode-header"><h3>Episod</h3><div class="autoplay-container"><label class="switch"><input type="checkbox" id="autoplayToggle" checked><span class="slider round"></span></label><span>Autoplay</span></div></div>
                <div id="episodeList"></div>
            </div>
        </div>
    </div>
    <script>
        const config = {
            apiBaseUrl: "https://captain.sapimu.au",
            proxyPath: "/api/proxy"
        };
        const homepage = document.getElementById('homepage');
        const detailsPage = document.getElementById('details-page');
        const backButton = document.getElementById('backButton');
        const categoryContainer = document.getElementById('category-container');
        const videoPlayer = document.getElementById('videoPlayer');
        const videoTitle = document.getElementById('videoTitle');
        const episodeList = document.getElementById('episodeList');
        const autoplayToggle = document.getElementById('autoplayToggle');
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');

        function showPage(pageName) {
            homepage.style.display = pageName === 'home' ? 'block' : 'none';
            detailsPage.style.display = pageName === 'details' ? 'block' : 'none';
        }

        async function apiCall(endpoint, lang = 'in') {
            const targetUrl = `${config.apiBaseUrl}${endpoint}?lang=${lang}`;
            const proxyUrl = `${config.proxyPath}?url=${encodeURIComponent(targetUrl)}`;
            console.log(`Memanggil proksi Vercel: ${proxyUrl}`);
            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`Ralat HTTP: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error(`Ralat API:`, error);
                categoryContainer.innerHTML = `<div class="loading">Gagal memuatkan data. Sila periksa log Vercel.</div>`;
                return null;
            }
        }
        
        function displayCategory(title, dramas) {
            const section = document.createElement('section'); section.className = 'category-section';
            section.innerHTML = `<h2>${title}</h2><div class="drama-grid"></div>`;
            const grid = section.querySelector('.drama-grid');
            if (!dramas || dramas.length === 0) {
                grid.innerHTML = '<div class="loading" style="text-align: left; padding-left: 0;">Tiada dalam kategori ini.</div>';
            } else {
                dramas.forEach(drama => {
                    const card = document.createElement('div'); card.className = 'drama-card';
                    card.innerHTML = `<img src="${drama.cover}" alt="${drama.bookName}"><div class="drama-card-title">${drama.bookName}</div>`;
                    card.addEventListener('click', () => showDetailsPage(drama.bookId, drama.bookName));
                    grid.appendChild(card);
                });
            }
            categoryContainer.appendChild(section);
        }

        async function loadAllCategories() {
            showPage('home');
            categoryContainer.innerHTML = '<div class="loading">Memuatkan semua kategori...</div>';
            const categories = [
                { title: "Terbaru", endpoint: "/dramabox/api/v1/new/1?pageSize=20", key: 'list' },
                { title: "Paling Hangat", endpoint: "/dramabox/api/v1/rank/1?pageSize=20", key: 'list' },
                { title: "Mesti Tonton", endpoint: "/dramabox/api/v1/classify?pageSize=20&sort=1", key: 'list' }
            ];
            const responses = await Promise.all(categories.map(cat => apiCall(cat.endpoint)));
            categoryContainer.innerHTML = '';
            responses.forEach((response, index) => {
                const cat = categories[index];
                if (response && response.data && response.data[cat.key]) {
                    displayCategory(cat.title, response.data[cat.key]);
                }
            });
        }

        async function showDetailsPage(bookId, title) {
            showPage('details'); videoTitle.textContent = title;
            episodeList.innerHTML = '<div class="loading">Memuatkan episod...</div>'; videoPlayer.src = "";
            const response = await apiCall(`/dramabox/api/v1/chapters/${bookId}`);
            if (response && response.data && response.data.chapterList) {
                displayEpisodes(response.data.chapterList, bookId);
                if (response.data.chapterList.length > 0) playVideo(bookId, response.data.chapterList[0].chapterIndex);
            } else { displayEpisodes([], bookId); }
        }

        function displayEpisodes(episodes, bookId) {
            episodeList.innerHTML = ''; if (episodes.length === 0) { episodeList.innerHTML = '<div class="loading">Tiada episod ditemui.</div>'; return; }
            episodes.forEach(episode => {
                const item = document.createElement('div'); item.className = 'episode-item';
                item.textContent = `Episod ${episode.chapterIndex + 1}`;
                item.dataset.index = episode.chapterIndex;
                item.addEventListener('click', () => playVideo(bookId, episode.chapterIndex));
                episodeList.appendChild(item);
            });
        }

        async function playVideo(bookId, index) {
            const response = await apiCall(`/dramabox/api/v1/watch/${bookId}/${index}`);
            if (response && response.data && response.data.videoUrl) {
                videoPlayer.src = response.data.videoUrl;
                videoPlayer.play();
                videoTitle.textContent = `${response.data.bookName} (Episod ${index + 1})`;
                videoPlayer.dataset.currentBookId = bookId;
                videoPlayer.dataset.currentEpisodeIndex = index;
                document.querySelectorAll('.episode-item').forEach(item => item.classList.remove('playing'));
                const currentEp = episodeList.querySelector(`[data-index='${index}']`);
                if (currentEp) currentEp.classList.add('playing');
            } else { alert("Gagal mendapatkan URL video."); }
        }

        videoPlayer.addEventListener('ended', () => {
            if (autoplayToggle.checked) {
                const currentIndex = parseInt(videoPlayer.dataset.currentEpisodeIndex, 10);
                const nextButton = episodeList.querySelector(`[data-index='${currentIndex + 1}']`);
                if (nextButton) nextButton.click();
            }
        });
        
        async function searchDramas() { /* ... fungsi carian ... */ }

        backButton.addEventListener('click', loadAllCategories);
        searchButton.addEventListener('click', searchDramas);
        searchInput.addEventListener('keypress', e => { if (e.key === 'Enter') searchDramas(); });

        loadAllCategories();
    </script>
</body>
</html>
